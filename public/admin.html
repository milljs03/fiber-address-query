<!DOCTYPE html>
<html>
  <head>
    <title>NPTEL Admin Portal</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
       /* Local overrides */
       #campaign-selector-wrapper { display: none; margin-left: 10px; border-left: 1px solid #ccc; padding-left: 10px; align-items: center; gap: 5px; }
       #campaign-select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
       
       /* New Card Style for Queries */
       .teal-card { border-left: 4px solid #17a2b8; background: #e0f7fa; }
       .teal-card .icon-box { background: #b2ebf2; color: #17a2b8; }
    </style>
  </head>
  <body>

    <div id="login-screen">
      <h1>NPTEL Admin Portal</h1>
      <p>Authorized Personnel Only</p>
      <button id="login-btn">Sign in with Google</button>
      <div id="auth-message" class="error-msg"></div>
    </div>

    <div id="app-container">
      
      <nav class="top-nav">
        <div class="nav-left">
            <span class="brand">NPTEL Admin</span>
            <div class="tabs">
                <button class="tab-btn active" data-tab="map-view"><i class="fa-solid fa-map"></i> Map Editor</button>
                <button class="tab-btn" data-tab="campaign-view"><i class="fa-solid fa-tags"></i> Campaigns</button>
                <button class="tab-btn" data-tab="analytics-view"><i class="fa-solid fa-chart-line"></i> Analytics & Orders</button>
            </div>
        </div>
        <div class="nav-right">
            <span id="user-display"></span>
            <button id="logout-btn" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>
      </nav>

      <div id="map-view" class="tab-content active">
          <div id="controls">
            <button id="import-btn" class="action-btn"><i class="fa-solid fa-file-import"></i> Import</button>
            <input type="file" id="import-input" accept=".json,.kml,.kmz" style="display: none;">
            <button id="export-btn" class="action-btn"><i class="fa-solid fa-file-export"></i> Export</button>
            
            <div id="campaign-selector-wrapper">
                <label for="campaign-select" style="font-size: 0.85rem; font-weight: bold;">Assign Campaign:</label>
                <select id="campaign-select">
                    <option value="">No Campaign (Default)</option>
                </select>
            </div>
            <div id="admin-instructions">
              <strong>How to Edit:</strong> Click a colored zone to select it.
            </div>
          </div>
          <div id="map"></div>
      </div>

      <div id="campaign-view" class="tab-content">
          <div class="campaign-dashboard-container">
              
              <div class="campaign-view-header">
                  <div>
                      <h2>Campaign Management</h2>
                      <p>Manage pricing zones, special offers, and global defaults.</p>
                  </div>
                  <button id="btn-create-campaign" class="action-btn primary large">
                      <i class="fa-solid fa-plus"></i> New Campaign
                  </button>
              </div>

              <div id="campaigns-grid" class="campaign-grid">
                  <div class="loading-state">Loading campaigns...</div>
              </div>
          </div>
      </div>

      <div id="analytics-view" class="tab-content">
          <div class="dashboard-container">
              <div class="stats-grid">
                  <div class="stat-card blue-card">
                      <div class="icon-box"><i class="fa-solid fa-cart-shopping"></i></div>
                      <div class="stat-info"><h3 id="stat-total-label">Total Orders</h3><p id="stat-total-val">--</p></div>
                  </div>

                  <div class="stat-card green-card">
                      <div class="icon-box"><i class="fa-solid fa-check-circle"></i></div>
                      <div class="stat-info"><h3>Serviceable</h3><p id="stat-serviceable-val">--</p></div>
                  </div>
                  <div class="stat-card purple-card">
                      <div class="icon-box"><i class="fa-solid fa-bullseye"></i></div>
                      <div class="stat-info"><h3>Conversion</h3><p id="stat-conversion-val">--%</p></div>
                  </div>
                  <!-- Total Unique Queries -->
                  <div class="stat-card teal-card">
                      <div class="icon-box"><i class="fa-solid fa-magnifying-glass-location"></i></div>
                      <div class="stat-info"><h3>Unique Queries</h3><p id="stat-queries-val">--</p></div>
                  </div>
              </div>

              <div class="charts-grid">
                  <div class="chart-box">
                      <h4>Plan Distribution</h4>
                      <div class="chart-wrapper"><canvas id="planChart"></canvas></div>
                  </div>
                  <div class="chart-box">
                      <h4>Address Checks (Availability)</h4>
                      <div class="chart-wrapper"><canvas id="activityChart"></canvas></div>
                  </div>
              </div>

              <div class="data-section">
                  <div class="section-header">
                      <div>
                          <h2 id="table-title">Recent Orders</h2>
                          <div class="view-switcher-container">
                              <button class="view-btn active" onclick="window.switchTableView('orders')">Orders</button>
                              <button class="view-btn" onclick="window.switchTableView('leads')">Leads</button>
                              <button class="view-btn" onclick="window.switchTableView('activity')">Activity</button>
                          </div>
                      </div>
                      <div class="header-actions">
                          <button id="export-current-btn" class="action-btn small"><i class="fa-solid fa-file-csv"></i> Export View</button>
                          <button id="refresh-data-btn" class="icon-btn" title="Refresh Data"><i class="fa-solid fa-arrows-rotate"></i></button>
                      </div>
                  </div>
                  <div class="table-wrapper">
                      <table id="main-data-table">
                          <thead>
                              <!-- Headers injected via JS -->
                          </thead>
                          <tbody>
                              <!-- Rows injected via JS -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>

    </div>

    <div id="campaign-modal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <h2 id="modal-title">Edit Campaign</h2>
                <button type="button" class="close-modal-btn" id="btn-close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="campaign-form">
                    
                    <div class="modal-section">
                        <h3><i class="fa-solid fa-sliders"></i> General Settings</h3>
                        <div class="form-row">
                            <div class="form-col" style="flex: 2;">
                                <label>Campaign Name</label>
                                <input type="text" id="camp-name" placeholder="e.g. Summer Sale 2024" required>
                            </div>
                            <!-- Expiration Date Input -->
                            <div class="form-col">
                                <label>Expires On (Optional)</label>
                                <input type="date" id="camp-expires" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div class="form-col">
                                <label>Zone Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="camp-color" value="#ff0000">
                                </div>
                            </div>
                        </div>
                        <div class="form-row checkbox-row" id="default-checkbox-container">
                             <label class="toggle-switch">
                                <input type="checkbox" id="is-default-pricing">
                                <span class="slider round"></span>
                             </label>
                             <div class="toggle-label">
                                 <strong>Set as Global Default</strong>
                                 <small>Apply these prices to all areas without a specific campaign zone.</small>
                             </div>
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="section-flex-header">
                            <h3><i class="fa-solid fa-list-check"></i> Pricing Tiers</h3>
                            <button type="button" id="add-plan-btn" class="action-btn small primary-text"><i class="fa-solid fa-plus"></i> Add Tier</button>
                        </div>
                        <div id="plans-container">
                            </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="action-btn" id="btn-cancel-modal">Cancel</button>
                        <button type="submit" class="action-btn primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
      window.isGoogleMapsReady = false;
      window.initMap = function() {
        window.isGoogleMapsReady = true;
        window.dispatchEvent(new Event('google-maps-ready'));
      };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBw8z2IL4dN5oldPzRW3a581mkXC7VuXe4&loading=async&libraries=drawing,geometry,places&callback=initMap" async defer></script>
    <script type="module" src="admin.js"></script>
  </body>
</html>