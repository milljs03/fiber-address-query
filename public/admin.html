<!DOCTYPE html>
<html>
  <head>
    <title>NPTEL Admin Portal</title>
    <link rel="stylesheet" href="admin.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Suppress favicon 404 error -->
    <link rel="icon" href="data:,">
    <style>
      /* Inline styles for the new report buttons */
      .header-actions { display: flex; gap: 10px; align-items: center; }
      .action-btn.small { font-size: 0.85rem; padding: 5px 10px; background-color: #f8f9fa; border: 1px solid #ced4da; }
      .action-btn.small:hover { background-color: #e2e6ea; border-color: #adb5bd; }

      /* Campaign Manager Styles */
      .campaign-layout { display: flex; gap: 30px; height: 100%; padding: 20px; }
      .campaign-form { flex: 1; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-y: auto; }
      .campaign-list { flex: 1; overflow-y: auto; }
      
      .form-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
      .form-section h3 { margin-top: 0; color: #2c3e50; font-size: 1.1rem; }
      .form-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
      .form-col { flex: 1; }
      .form-col.narrow { flex: 0 0 50px; }
      .form-col label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #555; }
      .form-col input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
      
      .campaign-card { background: white; padding: 15px; border-radius: 6px; border-left: 5px solid #ccc; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
      .campaign-card h4 { margin: 0 0 5px 0; font-size: 1.1rem; }
      .campaign-card p { margin: 0; font-size: 0.9rem; color: #666; }
      .campaign-actions { position: absolute; top: 15px; right: 15px; }
      .btn-delete-campaign { color: #dc3545; background: none; border: none; cursor: pointer; }
      .btn-remove-row { color: #dc3545; background: none; border: 1px solid #dc3545; border-radius: 4px; padding: 7px; cursor: pointer; }
      .btn-remove-row:hover { background: #fee2e2; }

      /* Map Controls Update */
      #campaign-selector-wrapper { display: none; margin-left: 10px; border-left: 1px solid #ccc; padding-left: 10px; align-items: center; gap: 5px; }
      #campaign-select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
      
      #plans-container { margin-bottom: 15px; }
      .plan-row { background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #eee; }
    </style>
  </head>
  <body>

    <!-- Login Screen -->
    <div id="login-screen">
      <h1>NPTEL Admin Portal</h1>
      <p>Authorized Personnel Only</p>
      <button id="login-btn">Sign in with Google</button>
      <div id="auth-message" class="error-msg"></div>
    </div>

    <!-- Main App Container -->
    <div id="app-container">
      
      <!-- Top Navigation Bar -->
      <nav class="top-nav">
        <div class="nav-left">
            <span class="brand">NPTEL Admin</span>
            <div class="tabs">
                <button class="tab-btn active" data-tab="map-view"><i class="fa-solid fa-map"></i> Map Editor</button>
                <button class="tab-btn" data-tab="campaign-view"><i class="fa-solid fa-tags"></i> Campaigns</button>
                <button class="tab-btn" data-tab="analytics-view"><i class="fa-solid fa-chart-line"></i> Analytics & Orders</button>
            </div>
        </div>
        <div class="nav-right">
            <span id="user-display"></span>
            <button id="logout-btn" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>
      </nav>

      <!-- TAB 1: MAP VIEW -->
      <div id="map-view" class="tab-content active">
          <div id="controls">
            <!-- Map Controls -->
            <button id="import-btn" class="action-btn"><i class="fa-solid fa-file-import"></i> Import</button>
            <input type="file" id="import-input" accept=".json,.kml,.kmz" style="display: none;">
            
            <button id="export-btn" class="action-btn"><i class="fa-solid fa-file-export"></i> Export</button>
            
            <!-- Campaign Assignment Control -->
            <div id="campaign-selector-wrapper">
                <label for="campaign-select" style="font-size: 0.85rem; font-weight: bold;">Assign Campaign:</label>
                <select id="campaign-select">
                    <option value="">No Campaign (Default)</option>
                    <!-- Populated by JS -->
                </select>
            </div>

            <div id="admin-instructions">
              <strong>How to Edit:</strong> Click a colored zone to select it.
            </div>
          </div>
          <div id="map"></div>
      </div>

      <!-- TAB 2: CAMPAIGN MANAGER -->
      <div id="campaign-view" class="tab-content">
          <div class="campaign-layout">
              <!-- Create Form -->
              <div class="campaign-form">
                  <h2 style="margin-top:0;">Create/Edit Campaign</h2>
                  <form id="campaign-form">
                      <div class="form-section">
                          <div class="form-row">
                              <div class="form-col">
                                  <label>Campaign Name</label>
                                  <input type="text" id="camp-name" placeholder="e.g. Summer Sale" required>
                              </div>
                              <div class="form-col">
                                  <label>Zone Color</label>
                                  <input type="color" id="camp-color" value="#ff0000" style="height: 35px; padding: 2px;">
                              </div>
                          </div>
                      </div>

                      <!-- Dynamic Plans Section -->
                      <div class="form-section">
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                              <h3>Plan Overrides</h3>
                              <button type="button" id="add-plan-btn" class="action-btn small"><i class="fa-solid fa-plus"></i> Add Plan</button>
                          </div>
                          
                          <div id="plans-container">
                              <!-- Dynamic Rows will be inserted here -->
                          </div>
                      </div>

                      <button type="submit" class="action-btn" style="background-color: #00a651; color: white; border:none; width: 100%; padding: 12px; font-size: 1rem;">Save Campaign</button>
                  </form>
              </div>

              <!-- List -->
              <div class="campaign-list">
                  <h2 style="margin-top:0;">Active Campaigns</h2>
                  <div id="campaigns-container">
                      <!-- Cards go here -->
                      <p style="color: #666;">Loading campaigns...</p>
                  </div>
              </div>
          </div>
      </div>

      <!-- TAB 3: ANALYTICS VIEW -->
      <div id="analytics-view" class="tab-content">
          <div class="dashboard-container">
              
              <!-- Stats Cards -->
              <div class="stats-row">
                  <!-- Will be populated by JS -->
                  <div class="stat-card loading">Loading stats...</div>
              </div>

              <!-- Orders Table -->
              <div class="data-section">
                  <div class="section-header">
                      <h2>Recent Orders (View Only)</h2>
                      <div class="header-actions">
                          <button id="export-orders-btn" class="action-btn small"><i class="fa-solid fa-file-csv"></i> Export Orders</button>
                          <button id="export-activity-btn" class="action-btn small"><i class="fa-solid fa-list"></i> Export Activity</button>
                          <button id="refresh-data-btn" class="icon-btn" title="Refresh Data"><i class="fa-solid fa-arrows-rotate"></i></button>
                      </div>
                  </div>
                  <div class="table-wrapper">
                      <table id="orders-table">
                          <thead>
                              <tr>
                                  <th>Date</th>
                                  <th>Name</th>
                                  <th>Plan</th>
                                  <th>Address</th>
                                  <th>Contact</th>
                              </tr>
                          </thead>
                          <tbody>
                              <!-- Populated by JS -->
                          </tbody>
                      </table>
                  </div>
                  <!-- Hidden input to hold state if needed for later features, otherwise just visual -->
                  <div style="display:none;" id="stat-total-orders"></div>
                  <div style="display:none;" id="stat-pending"></div>
              </div>

          </div>
      </div>

    </div>

    <!-- 1. BRIDGE SCRIPT -->
    <script>
      window.isGoogleMapsReady = false;
      window.initMap = function() {
        window.isGoogleMapsReady = true;
        window.dispatchEvent(new Event('google-maps-ready'));
      };
    </script>

    <!-- 2. EXTERNAL LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

    <!-- 3. GOOGLE MAPS API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBw8z2IL4dN5oldPzRW3a581mkXC7VuXe4&libraries=drawing,geometry,places&callback=initMap" async defer></script>
    
    <!-- 4. MAIN LOGIC -->
    <script type="module" src="admin.js"></script>
  </body>
</html>